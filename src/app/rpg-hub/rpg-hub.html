<main class="main-container">
  <!-- Sidebar -->
  <div class="sidebar-overlay" [class.show]="showSidebar" (click)="toggleSidebar()">
    <button class="btn"><fa-icon [icon]="faBars" /></button>
  </div>
  <aside class="sidebar" [class.collapsed]="!showSidebar" [class.open]="showSidebar">
    <nav>
      <!-- Logo e menu -->
      <button (click)="toggleSidebar()">
        @if (showSidebar){
          <span class="label"><b>D</b>ungeon<b>M</b>ind</span>
        }
        <fa-icon class="icon" [icon]="faBars" />
      </button>

      <!-- Criar registros -->
      <button (click)="createCharacter()">
        <fa-icon class="icon" [icon]="faUserPlus" />
        @if (showSidebar){
          <span class="label">Novo Personagem</span>
        }
      </button>

      @if (characters.length){
        <button (click)="selectedCampaign = {}; personagem_id.setValue(''); messages = []">
          <fa-icon class="icon" [icon]="faPlus" />
          @if (showSidebar){
            <span class="label">Nova Campanha</span>
          }
        </button>
      }
      @if (campaigns.length || characters.length){
        <hr class="w-[80%] border-[#c9a66b] my-1 mx-auto">
      }
      <!-- Campanhas -->
      @if (campaigns.length){
        <button (click)="toggleCampaigns()">
          <fa-icon class="icon" [icon]="faBook" />
          @if (showSidebar){
            <span class="label">Campanhas</span>
            @if (!showCampaigns){
              <fa-icon class="last" [icon]="faCaretDown" />
            } @else {
              <fa-icon class="last" [icon]="faCaretUp" />
            }
          }
        </button>
        <div class="accordion-body" [class.open]="showCampaigns">
          @for (campaign of campaigns; track campaign.campanha_id; let i = $index) {
            <div class="item" (click)="listCampaigns(campaign.campanha_id)">
              <span>{{ campaign.titulo ? campaign.titulo : '...' }}</span>
              <button class="delete" (click)="deleteCampaign(campaign.campanha_id); $event.stopPropagation()">
                <fa-icon [icon]="faXmark" />
              </button>
            </div>
          }
        </div>
      }

      <!-- Personagens -->
      @if (characters.length){
        <button (click)="toggleCharacters()">
          <fa-icon class="icon" [icon]="faPeopleGroup" />
          @if (showSidebar){
            <span class="label">Personagens</span>
            @if (!showCharacters){
              <fa-icon class="last" [icon]="faCaretDown" />
            } @else {
              <fa-icon class="last" [icon]="faCaretUp" />
            }
          }
        </button>
        <div class="accordion-body" [class.open]="showCharacters">
          @for (char of characters; track char.personagem_id; let i = $index) {
            <div class="item" (click)="editCharacter(char.personagem_id)">
              <span>{{ `${char.nome}, ${char.classe} ${char.raca}` }}</span>
              <button class="delete" (click)="deleteCharacter(char.personagem_id); $event.stopPropagation()">
                <fa-icon [icon]="faXmark" />
              </button>
            </div>
          }
        </div>
      }

      <!-- Sair -->
      <button class="bottom" (click)="logout()">
        <fa-icon class="icon" [icon]="faArrowRightFromBracket" />
        @if (showSidebar){
          <span class="label">Sair</span>
        }
      </button>
    </nav>
  </aside>

  <!-- Main Chat -->
  <div class="chat-container" [class.dimmed]="showSidebar">
    <div class="chat-messages">
      @for (msg of messages; track $index) {
        <div class="message" [class]="msg.origin"><span [innerHTML]="msg.text ? msg.text : '...'"></span></div>
      }
    </div>
    <div class="chat-options" [class.center]="!selectedCampaign.campanha_id">
      <div class="char-info">
        @if (personagem_id.value) {
          <span class="info-id">
            {{ selectedCharacter?.nome }}
          </span>|
          <!-- TODO: Implementar alteração de stats do jogador -->
          <span id="info-hp" class="text-red-500">
            <fa-icon class="icon" [icon]="faHeart" />
            {{ `${selectedCharacter?.stats.pv}/${selectedCharacter?.stats.pv_max}` }}
          </span>|
          <span id="info-ep" class="text-blue-700">
            <fa-icon class="icon" [icon]="faBoltLightning" />
            {{ `${selectedCharacter?.stats.pe}/${selectedCharacter?.stats.pe_max}` }}
          </span>|
          <!-- TODO: Implementar sistema de níveis -->
          <span id="info-lvl" class="text-black">Nível {{ selectedCharacter.level }}</span>|
          <span id="info-xp" class="text-gray-500">XP: {{ `${selectedCharacter.xp}/${selectedCharacter.level + 2}` }}</span>
        }
      </div>

      <div class="chat-input" [class.mobile]="!selectedCampaign.campanha_id">
        @if (!characters.length) {
          <button class=" btn w-full whitespace-nowrap" (click)="createCharacter()">
            <fa-icon class="icon" [icon]="faUserPlus" />
            Crie seu personagem
          </button>
        } @else if (!selectedCampaign.campanha_id) {
          <mat-form-field class="w-full whitespace-nowrap" >
            <mat-label>Selecione um personagem</mat-label>
            <mat-select [formControl]="personagem_id" [errorStateMatcher]="matcher" (selectionChange)="selectCharacter()">
              @for (char of characters; track char.personagem_id) {
                <mat-option [value]="char.personagem_id">{{ `${char.nome}, ${char.classe} ${char.raca}` }}</mat-option>
              }
            </mat-select>
            @if (!personagem_id.valid) {
              <mat-error>Selecionar um personagem é <strong>obrigatório</strong></mat-error>
            }
          </mat-form-field>
          <button class="btn mb-[20px]" (click)="createCampaign()" [class.w-full.whitespace-nowrap]="!selectedCampaign.campanha_id">
            <fa-icon class="icon" [icon]="faUserPlus" />
            Iniciar nova campanha
          </button>
        } @else {
          <!-- TODO: Implementar inventário -->
          <button class="btn"><fa-icon class="icon" [icon]="faSackXmark" /></button>
          <input type="text" matInput [formControl]="prompt" placeholder="Digite sua ação..." (keydown.enter)="editCampaign()"/>
          <button class="btn" (click)="editCampaign()"><fa-icon class="icon" [icon]="faPaperPlane" /></button>
        }
      </div>
      @if (!prompt.valid && prompt.dirty) {
        <mat-error class="text-red-500">O preenchimento deste campo é <strong>obrigatório</strong></mat-error>
      }
    </div>
  </div>
</main>
